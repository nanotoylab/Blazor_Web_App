@using Blazor_Web_App.Models
@using Microsoft.EntityFrameworkCore
@inject PubsDBContext pubsDBContext
@inject IJSRuntime JsRuntime

@page "/LearnCRUD/CommentList/CommentEdit"
@page "/LearnCRUD/CommentList/CommentEdit/{ID:int}"
<PageTitle>CommentEdit</PageTitle>



@if(ID == null)
{
    // 追加モード
    <h3>コメント追加画面</h3>
    <textarea @bind="record.Comment" rows="10" style="width:100%;"></textarea>
    <button class="btn btn-primary" @onclick="CreateRecord">追加</button>
}
else
{
    <h3>コメント編集画面</h3>

    // 編集モード
    if (record == null)
    {
        <p><em>ロード中...</em></p>
    }
    else
    {
        <textarea @bind="record.Comment" rows="10" style="width:100%;"></textarea>
        <br />
        <button class="btn btn-primary" @onclick="UpdateRecord">更新</button>
        <button class="btn btn-danger" @onclick="DeleteRecord">削除</button>
    }
}


@code {
    [Parameter]
    public int? ID { get; set; }

    private Test record;

    [Inject]
    private NavigationManager navigationManager { get; set; } = null;

    // 非同期処理でDBから取得
    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (ID == null)
            {
                record = new Test();
            }
            else
            {
                record = await pubsDBContext.Tests.Where(a => a.Id.Equals(ID)).FirstOrDefaultAsync();
            }
        }
        catch(Exception ex)
        {
            // エラー処理（開発環境でのみ表示するなどの工夫をしてください）
            record = new Test();
            Console.WriteLine($"データの読み込み中にエラーが発生しました: {ex.Message}");
        }
    }

    private async Task CreateRecord()
    {
        try
        {   
            // JS Interop を使用して、JavaScriptの confirmDelete 関数を呼び出す
            bool confirmed = await JsRuntime.InvokeAsync<bool>(
                "confirm", // JavaScript関数名
                "レコードを追加してもよろしいですか？"
            );

            if (!confirmed) return;


            record.Name = "test";
            record.CreatedAt = DateTime.Now;
            record.UpdateAt = DateTime.Now;
            record.Comment = record.Comment; //@bind

            pubsDBContext.Tests.Add(record);
            await pubsDBContext.SaveChangesAsync();

            navigationManager.NavigateTo("/LearnCRUD/CommentList");

        }
        catch(Exception ex)
        {
            // エラー処理（開発環境でのみ表示するなどの工夫をしてください）
            record = new Test();
            Console.WriteLine($"データの追加中にエラーが発生しました: {ex.Message}");
        }
    }

    private async Task UpdateRecord()
    {
        try
        {
            if (record != null)
            {
                record.UpdateAt = DateTime.Now;

                // DbContextは自動的に変更を追跡しているため、SaveChangesを呼ぶだけ
                await pubsDBContext.SaveChangesAsync();
                // 更新後の処理（例：一覧画面に戻るなど）
                // NavigationManager.NavigateTo("/tests");

                navigationManager.NavigateTo("/LearnCRUD/CommentList");
            }
        }
        catch(Exception ex)
        {
            // エラー処理（開発環境でのみ表示するなどの工夫をしてください）
            record = new Test();
            Console.WriteLine($"データの更新中にエラーが発生しました: {ex.Message}");
        }
    }

    private async Task DeleteRecord()
    {
        try
        {
            // JS Interop を使用して、JavaScriptの confirmDelete 関数を呼び出す
            bool confirmed = await JsRuntime.InvokeAsync<bool>(
                "confirm", // JavaScript関数名
                "レコードを削除してもよろしいですか？"
            );

            if (!confirmed) return;

            var record = await pubsDBContext.Tests.Where(a => a.Id.Equals(ID)).FirstOrDefaultAsync();

            if (record != null)
            {
                pubsDBContext.Tests.Remove(record);
                await pubsDBContext.SaveChangesAsync();

                navigationManager.NavigateTo("/LearnCRUD/CommentList");
            }
        }
        catch(Exception ex)
        {
            // エラー処理（開発環境でのみ表示するなどの工夫をしてください）
            record = new Test();
            Console.WriteLine($"データの削除中にエラーが発生しました: {ex.Message}");
        }
    }
}

